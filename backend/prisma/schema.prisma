generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int            @id @default(autoincrement())
  username      String         @unique
  password      String
  name          String
  email         String?        @unique
  role          UserRole       @default(USER)
  projects      UserProject[]
  comments      Comment[]
  notifications Notification[]
  activities    ActivityLog[]
  timeEntries   TimeEntry[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model Project {
  id           Int            @id @default(autoincrement())
  name         String
  description  String?
  color        String         @default("#6c8cff")
  icon         String         @default("üìÅ")
  isActive     Boolean        @default(true)
  users        UserProject[]
  phases       Phase[]
  assignees    Assignee[]
  tags         Tag[]
  customFields CustomField[]
  templates    TaskTemplate[]
  activities   ActivityLog[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model UserProject {
  id        Int         @id @default(autoincrement())
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId Int
  role      ProjectRole @default(MEMBER)
  createdAt DateTime    @default(now())

  @@unique([userId, projectId])
}

model Phase {
  id        Int      @id @default(autoincrement())
  name      String
  icon      String?
  color     String
  duration  String?
  order     Int      @default(0)
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId Int
  tasks     Task[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Assignee {
  id        Int      @id @default(autoincrement())
  name      String
  initials  String
  color     String
  role      String?
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId Int
  tasks     Task[]
  notes     Note[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Task {
  id           Int           @id @default(autoincrement())
  title        String
  status       TaskStatus    @default(NOT_STARTED)
  priority     Priority      @default(MEDIUM)
  dueDate      DateTime?
  description  String?
  phase        Phase         @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  phaseId      Int
  assignee     Assignee?     @relation(fields: [assigneeId], references: [id])
  assigneeId   Int?
  subtasks     Subtask[]
  deliverables Deliverable[]
  notes        Note[]
  comments     Comment[]
  attachments  Attachment[]
  tags         TaskTag[]
  timeEntries  TimeEntry[]
  customValues CustomFieldValue[]

  // Dependencies
  dependsOn    TaskDependency[] @relation("DependentTask")
  blockedBy    TaskDependency[] @relation("BlockingTask")

  // Recurring task config
  recurringConfig RecurringTask?
  parentTaskId    Int?          // If created from recurring

  // Template reference
  templateId   Int?

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Subtask {
  id        Int      @id @default(autoincrement())
  title     String
  completed Boolean  @default(false)
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Deliverable {
  id        Int      @id @default(autoincrement())
  label     String
  type      String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Note {
  id        Int       @id @default(autoincrement())
  content   String
  task      Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId    Int
  author    Assignee? @relation(fields: [authorId], references: [id])
  authorId  Int?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// ========== NEW MODELS ==========

// Task Dependencies (Task A blocks Task B)
model TaskDependency {
  id              Int      @id @default(autoincrement())
  dependentTask   Task     @relation("DependentTask", fields: [dependentTaskId], references: [id], onDelete: Cascade)
  dependentTaskId Int      // The task that depends on another
  blockingTask    Task     @relation("BlockingTask", fields: [blockingTaskId], references: [id], onDelete: Cascade)
  blockingTaskId  Int      // The task that must be completed first
  createdAt       DateTime @default(now())

  @@unique([dependentTaskId, blockingTaskId])
}

// Comments (threaded discussions on tasks)
model Comment {
  id        Int       @id @default(autoincrement())
  content   String
  task      Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId    Int
  author    User      @relation(fields: [authorId], references: [id])
  authorId  Int
  parentId  Int?      // For threaded replies
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
  mentions  String?   // JSON array of mentioned user IDs
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// File Attachments
model Attachment {
  id        Int      @id @default(autoincrement())
  filename  String
  originalName String
  mimeType  String
  size      Int      // bytes
  url       String   // storage path or URL
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId    Int
  uploadedBy Int     // User ID who uploaded
  createdAt DateTime @default(now())
}

// Notifications
model Notification {
  id        Int              @id @default(autoincrement())
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  taskId    Int?             // Related task if applicable
  projectId Int?             // Related project if applicable
  actorId   Int?             // User who triggered the notification
  metadata  String?          // JSON for extra data
  createdAt DateTime         @default(now())
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_UPDATED
  TASK_COMPLETED
  COMMENT_ADDED
  MENTION
  DUE_DATE_REMINDER
  DEPENDENCY_RESOLVED
}

// Activity Log
model ActivityLog {
  id         Int          @id @default(autoincrement())
  action     ActivityType
  entityType String       // 'task', 'project', 'phase', etc.
  entityId   Int
  entityName String?      // Name of the entity for display
  changes    String?      // JSON of what changed
  user       User         @relation(fields: [userId], references: [id])
  userId     Int
  project    Project?     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId  Int?
  createdAt  DateTime     @default(now())
}

enum ActivityType {
  CREATED
  UPDATED
  DELETED
  STATUS_CHANGED
  ASSIGNED
  UNASSIGNED
  COMMENT_ADDED
  ATTACHMENT_ADDED
  DEPENDENCY_ADDED
  DEPENDENCY_REMOVED
}

// Tags/Labels
model Tag {
  id        Int       @id @default(autoincrement())
  name      String
  color     String    @default("#6c8cff")
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId Int
  tasks     TaskTag[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([name, projectId])
}

model TaskTag {
  id        Int      @id @default(autoincrement())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId    Int
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId     Int
  createdAt DateTime @default(now())

  @@unique([taskId, tagId])
}

// Time Tracking
model TimeEntry {
  id          Int       @id @default(autoincrement())
  task        Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId      Int
  user        User      @relation(fields: [userId], references: [id])
  userId      Int
  description String?
  startTime   DateTime
  endTime     DateTime?
  duration    Int?      // minutes (calculated or manual)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Recurring Tasks
model RecurringTask {
  id          Int             @id @default(autoincrement())
  task        Task            @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId      Int             @unique
  frequency   RecurFrequency
  interval    Int             @default(1) // every X days/weeks/months
  daysOfWeek  String?         // JSON array for weekly [0,1,2,3,4,5,6]
  dayOfMonth  Int?            // for monthly
  endDate     DateTime?       // when to stop recurring
  lastCreated DateTime?       // last time a task was created
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

enum RecurFrequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

// Task Templates
model TaskTemplate {
  id           Int      @id @default(autoincrement())
  name         String
  title        String
  description  String?
  priority     Priority @default(MEDIUM)
  subtasks     String?  // JSON array of subtask titles
  tags         String?  // JSON array of tag IDs
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId    Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// Custom Fields
model CustomField {
  id          Int              @id @default(autoincrement())
  name        String
  type        CustomFieldType
  options     String?          // JSON array for SELECT/MULTISELECT
  required    Boolean          @default(false)
  project     Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId   Int
  values      CustomFieldValue[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@unique([name, projectId])
}

model CustomFieldValue {
  id        Int         @id @default(autoincrement())
  value     String      // Store all values as string, parse based on type
  field     CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  fieldId   Int
  task      Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId    Int
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@unique([fieldId, taskId])
}

enum CustomFieldType {
  TEXT
  NUMBER
  DATE
  SELECT
  MULTISELECT
  CHECKBOX
  URL
}

// ========== EXISTING ENUMS ==========

enum UserRole {
  ADMIN
  USER
}

enum ProjectRole {
  OWNER
  MEMBER
  VIEWER
}

enum TaskStatus {
  NOT_STARTED
  IN_PROGRESS
  BLOCKED
  DONE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

// ========== LOW PRIORITY FEATURES ==========

// Filter Presets
model FilterPreset {
  id          Int      @id @default(autoincrement())
  name        String
  filters     String   // JSON: { phases, statuses, priorities, assignees, tags, search }
  isDefault   Boolean  @default(false)
  userId      Int
  projectId   Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([name, userId, projectId])
}

// User Settings
model UserSettings {
  id                    Int      @id @default(autoincrement())
  userId                Int      @unique
  theme                 String   @default("dark") // dark, light, system
  keyboardShortcuts     Boolean  @default(true)
  emailNotifications    Boolean  @default(false)
  emailTaskAssigned     Boolean  @default(true)
  emailTaskCompleted    Boolean  @default(true)
  emailMentions         Boolean  @default(true)
  emailDueReminders     Boolean  @default(true)
  reminderDaysBefore    Int      @default(1)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ========== HIGH PRIORITY FEATURES ==========

// Granular Permissions per user per project
model ProjectPermission {
  id              Int      @id @default(autoincrement())
  userId          Int
  projectId       Int

  // Task permissions
  canCreateTasks  Boolean  @default(true)
  canEditTasks    Boolean  @default(true)
  canDeleteTasks  Boolean  @default(false)
  canAssignTasks  Boolean  @default(true)

  // Phase permissions
  canManagePhases Boolean  @default(false)

  // Team permissions
  canManageTeam   Boolean  @default(false)

  // Settings permissions
  canManageProject Boolean @default(false)

  // View restrictions (JSON array of phase IDs user can see, null = all)
  visiblePhases   String?  // JSON array: [1, 2, 3] or null for all

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, projectId])
}
